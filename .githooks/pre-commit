#!/bin/bash
# Pre-commit hook para SintaxisIA
# Valida requisitos cr√≠ticos antes de permitir commit

echo "üîç Ejecutando validaciones pre-commit..."

ERRORS=0

# 1. Verificar package-lock.json existe
for lockfile in "package-lock.json" "automation/package-lock.json" "remotion-app/package-lock.json"; do
    if [ ! -f "$lockfile" ]; then
        echo "‚ùå ERROR: $lockfile no existe"
        ERRORS=$((ERRORS + 1))
    fi
done

# 2. Verificar package-lock.json NO est√° en .gitignore
if grep -q "^package-lock.json$" .gitignore 2>/dev/null; then
    echo "‚ùå ERROR: package-lock.json est√° en .gitignore"
    ERRORS=$((ERRORS + 1))
fi

# 3. Verificar .env NO est√° siendo commiteado
if git diff --cached --name-only | grep -qE "^\.env$"; then
    echo "‚ùå ERROR: Intentando commitear .env"
    ERRORS=$((ERRORS + 1))
fi

# 4. Verificar no hay archivos grandes (>5MB)
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 5242880 ]; then
            echo "‚ùå ERROR: Archivo muy grande: $file ($(($size / 1048576))MB)"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Resultado
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "üö´ Commit bloqueado: $ERRORS error(es)"
    exit 1
fi

echo "‚úÖ Validaciones OK"
exit 0
