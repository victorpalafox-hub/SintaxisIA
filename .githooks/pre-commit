#!/bin/bash
# Pre-commit hook para SintaxisIA
# Valida requisitos cr√≠ticos antes de permitir commit

echo "üîç Ejecutando validaciones pre-commit..."

ERRORS=0

# 1. Verificar package-lock.json existe
for lockfile in "package-lock.json" "automation/package-lock.json" "remotion-app/package-lock.json"; do
    if [ ! -f "$lockfile" ]; then
        echo "‚ùå ERROR: $lockfile no existe"
        ERRORS=$((ERRORS + 1))
    fi
done

# 2. Verificar package-lock.json NO est√° en .gitignore
if grep -q "^package-lock.json$" .gitignore 2>/dev/null; then
    echo "‚ùå ERROR: package-lock.json est√° en .gitignore"
    ERRORS=$((ERRORS + 1))
fi

# 3. Verificar .env NO est√° siendo commiteado
if git diff --cached --name-only | grep -qE "^\.env$"; then
    echo "‚ùå ERROR: Intentando commitear .env"
    ERRORS=$((ERRORS + 1))
fi

# 4. Verificar no hay archivos grandes (>5MB)
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 5242880 ]; then
            echo "‚ùå ERROR: Archivo muy grande: $file ($(($size / 1048576))MB)"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 5. Verificar rutas cr√≠ticas del proyecto
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CRITICAL_PATHS=(
    "remotion-app/package.json"
    "automation/package.json"
    "automation/src/config/video.config.ts"
    "tests/specs"
)

for p in "${CRITICAL_PATHS[@]}"; do
    if [ ! -e "$p" ]; then
        echo "‚ùå ERROR: Ruta cr√≠tica no existe: $p"
        echo "   Verifica que est√©s en el directorio ra√≠z del proyecto"
        ERRORS=$((ERRORS + 1))
    fi
done

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 6. Verificar VIDEO_PATHS no usa rutas relativas con '..'
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if [ -f "automation/src/config/video.config.ts" ]; then
    if grep -q "path\.resolve.*'\.\.'.*remotion-app" automation/src/config/video.config.ts; then
        echo "‚ùå ERROR: video.config.ts usa rutas relativas con '..' para remotion-app"
        echo "   Usa getProjectRoot() en lugar de process.cwd() + '..'"
        ERRORS=$((ERRORS + 1))
    fi
fi

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# 7. Validaci√≥n de TypeScript (previene errores en CI)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

echo "üìù Verificando tipos TypeScript..."

# 7a. Verificar tipos en automation/
if [ -d "automation" ] && [ -f "automation/tsconfig.json" ]; then
    echo "   Checking automation/..."
    TSC_OUTPUT=$(cd automation && npx tsc --noEmit 2>&1)
    TSC_EXIT=$?
    if [ $TSC_EXIT -ne 0 ]; then
        echo "‚ùå ERROR: Errores de TypeScript en automation/"
        echo "$TSC_OUTPUT" | head -20
        echo ""
        echo "   Ejecuta: cd automation && npx tsc --noEmit"
        ERRORS=$((ERRORS + 1))
    else
        echo "   ‚úì automation/ OK"
    fi
fi

# 7b. Verificar tipos en remotion-app/
if [ -d "remotion-app" ] && [ -f "remotion-app/tsconfig.json" ]; then
    echo "   Checking remotion-app/..."
    TSC_OUTPUT=$(cd remotion-app && npx tsc --noEmit 2>&1)
    TSC_EXIT=$?
    if [ $TSC_EXIT -ne 0 ]; then
        echo "‚ùå ERROR: Errores de TypeScript en remotion-app/"
        echo "$TSC_OUTPUT" | head -20
        echo ""
        echo "   Ejecuta: cd remotion-app && npx tsc --noEmit"
        ERRORS=$((ERRORS + 1))
    else
        echo "   ‚úì remotion-app/ OK"
    fi
fi

# Resultado
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "üö´ Commit bloqueado: $ERRORS error(es)"
    exit 1
fi

echo "‚úÖ Validaciones OK"
exit 0
