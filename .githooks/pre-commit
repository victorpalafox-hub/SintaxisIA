#!/bin/bash
# Pre-commit hook para SintaxisIA
# Valida requisitos crÃ­ticos antes de permitir commit

echo "ğŸ” Ejecutando validaciones pre-commit..."

ERRORS=0

# 1. Verificar package-lock.json existe
for lockfile in "package-lock.json" "automation/package-lock.json" "remotion-app/package-lock.json"; do
    if [ ! -f "$lockfile" ]; then
        echo "âŒ ERROR: $lockfile no existe"
        ERRORS=$((ERRORS + 1))
    fi
done

# 2. Verificar package-lock.json NO estÃ¡ en .gitignore
if grep -q "^package-lock.json$" .gitignore 2>/dev/null; then
    echo "âŒ ERROR: package-lock.json estÃ¡ en .gitignore"
    ERRORS=$((ERRORS + 1))
fi

# 3. Verificar .env NO estÃ¡ siendo commiteado
if git diff --cached --name-only | grep -qE "^\.env$"; then
    echo "âŒ ERROR: Intentando commitear .env"
    ERRORS=$((ERRORS + 1))
fi

# 4. Verificar no hay archivos grandes (>5MB)
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 5242880 ]; then
            echo "âŒ ERROR: Archivo muy grande: $file ($(($size / 1048576))MB)"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. Verificar rutas crÃ­ticas del proyecto
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRITICAL_PATHS=(
    "remotion-app/package.json"
    "automation/package.json"
    "automation/src/config/video.config.ts"
    "tests/specs"
)

for p in "${CRITICAL_PATHS[@]}"; do
    if [ ! -e "$p" ]; then
        echo "âŒ ERROR: Ruta crÃ­tica no existe: $p"
        echo "   Verifica que estÃ©s en el directorio raÃ­z del proyecto"
        ERRORS=$((ERRORS + 1))
    fi
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. Verificar VIDEO_PATHS no usa rutas relativas con '..'
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ -f "automation/src/config/video.config.ts" ]; then
    if grep -q "path\.resolve.*'\.\.'.*remotion-app" automation/src/config/video.config.ts; then
        echo "âŒ ERROR: video.config.ts usa rutas relativas con '..' para remotion-app"
        echo "   Usa getProjectRoot() en lugar de process.cwd() + '..'"
        ERRORS=$((ERRORS + 1))
    fi
fi

# Resultado
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "ğŸš« Commit bloqueado: $ERRORS error(es)"
    exit 1
fi

echo "âœ… Validaciones OK"
exit 0
